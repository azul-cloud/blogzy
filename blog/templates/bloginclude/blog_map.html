{% load static from staticfiles %}
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}"></script>
<script type="text/javascript" src="{% static 'js/oms.min.js' %}"></script>
<script type="text/javascript">
  function initialize() {
    gm = google.maps
    loc = {{ loc|safe }}
    center_latlng = new gm.LatLng(loc.lat, loc.lng)

    locationData = [
      {% for p in post_list %}
        {% if p.lat and p.long %}
          [{{ p.lat }},
          {{ p.long }},
          "{{ p }}",
          "{{ p.headline }}",
          "{{ p.get_absolute_url }}",
          "{% if p.image%}{{ p.image.url }}{% endif %}"],
        {% endif %}
      {% endfor %}
    ]

    var mapOptions = {
      center: center_latlng,
      zoom: {% if map_zoom %}{{ map_zoom }}{% else %}4{% endif %}
    };
    var map = new gm.Map(document.getElementById("map-canvas"),
      mapOptions);

    // allow users to click to see markers that are in close proximity
    var oms = new OverlappingMarkerSpiderfier(map);

    var infowindow = new gm.InfoWindow({
      maxWidth: 300,
    });

    for (var i in locationData)
    {
      var p = locationData[i];
      var latlng = new gm.LatLng(p[0], p[1]);

      var marker = new gm.Marker({
        position: latlng,
        map: map,
        icon: '/static/img/map_icon_sm.png',
        title: p[2],
        headline: p[3],
        link: p[4],
        imgURL: p[5],
      });

      var iw = new gm.InfoWindow();
      oms.addListener('click', function(marker, event) {
        content = "<a class='brand-light' href='" + marker.link + "'><h3 class='infowindow-title'>" +
          marker.title + "</h3><img class='img-responsive img-info-window' src='" + marker.imgURL + "' /></a> " +
          "<h4 class='text-center skinny'>" + marker.headline + "</p>"

        iw.setContent(content);
        iw.open(map, marker);
      });

      oms.addMarker(marker);

      /*
      gm.event.addListener(marker, 'click', function() {
        content = "<a class='brand-light' href='" + this.link + "'><h3 class='infowindow-title'>" +
          this.title + "</h3><img class='img-responsive' src='" + this.imgURL + "' /></a> " +
          "<h4 class='text-center skinny'>" + this.headline + "</p>"

        infowindow.setContent(content);
        infowindow.open(map, this);
      });
      */
    }
  }

  google.maps.event.addDomListener(window, 'load', initialize);
</script>
